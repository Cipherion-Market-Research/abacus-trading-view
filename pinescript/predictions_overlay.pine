//@version=6
indicator("Ciphex Price Predictions", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// CONFIGURATION
// ============================================================================

GITHUB_USER = "Cipherion-Market-Research"
GITHUB_REPO = "abacus-trading-view"
GITHUB_SOURCE = GITHUB_USER + "/" + GITHUB_REPO

// ============================================================================
// INPUTS
// ============================================================================

i_showBands      = input.bool(true, "Show Prediction Bands", group="Display")
i_showMidLine    = input.bool(true, "Show Mid Line", group="Display")
i_showLabels     = input.bool(true, "Show Price Labels", group="Display")
i_showInfoTable  = input.bool(true, "Show Info Table", group="Display")

i_highColor      = input.color(color.new(#00C853, 20), "High Prediction", group="Colors")
i_midColor       = input.color(color.new(#FFD600, 20), "Mid Prediction", group="Colors")
i_lowColor       = input.color(color.new(#FF5252, 20), "Low Prediction", group="Colors")

i_lineWidth      = input.int(2, "Line Width", minval=1, maxval=4, group="Style")
i_labelSize      = input.string("small", "Label Size", options=["tiny", "small", "normal"], group="Style")

// ============================================================================
// SYMBOL DETECTION
// ============================================================================

getDataPath() =>
    sym = str.lower(syminfo.ticker)

    // Remove exchange prefix if present
    if str.contains(sym, ":")
        parts = str.split(sym, ":")
        sym := array.get(parts, 1)

    // Clean up common suffixes
    sym := str.replace_all(sym, ".p", "")
    sym := str.replace_all(sym, "perp", "")

    // Determine asset type subdirectory
    isCrypto = str.endswith(sym, "usdt") or (str.endswith(sym, "usd") and str.length(sym) > 6)
    isDex = str.contains(sym, "trump") or str.contains(sym, "fart")

    subdir = isDex ? "dex" : (isCrypto ? "crypto" : "stock")

    subdir + "/" + sym + "_predictions"

DATA_PATH = getDataPath()

// ============================================================================
// DATA LOADING VIA request.seed()
// ============================================================================

// CSV columns: time, low, mid, high, probability, signal, direction, status, block, horizon_index
// request.seed() maps CSV columns to built-in series names

predLow = request.seed(GITHUB_SOURCE, DATA_PATH, low)
predMid = request.seed(GITHUB_SOURCE, DATA_PATH, close)
predHigh = request.seed(GITHUB_SOURCE, DATA_PATH, high)

// Check if we have valid data
hasData = not na(predLow) and not na(predMid) and not na(predHigh)

// ============================================================================
// STATE VARIABLES
// ============================================================================

var line[] highLines = array.new_line()
var line[] midLines = array.new_line()
var line[] lowLines = array.new_line()
var label[] predLabels = array.new_label()
var linefill[] bandFills = array.new_linefill()

var float prevHigh = na
var float prevMid = na
var float prevLow = na
var int prevBarTime = na

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

getLabelSize() =>
    switch i_labelSize
        "tiny" => size.tiny
        "small" => size.small
        "normal" => size.normal
        => size.small

getBlockColor(idx) =>
    // Block 1: horizons 0-4, Block 2: 5-9, Block 3: 10-14
    blockNum = math.floor(idx / 5) + 1
    switch blockNum
        1 => color.new(#2196F3, 70)
        2 => color.new(#4CAF50, 70)
        3 => color.new(#9C27B0, 70)
        => color.new(#607D8B, 70)

// ============================================================================
// DRAWING FUNCTIONS
// ============================================================================

drawPredictionLines(int t1, float h1, float m1, float l1, int t2, float h2, float m2, float l2) =>
    lineHigh = line.new(x1=t1, y1=h1, x2=t2, y2=h2, xloc=xloc.bar_time, color=i_highColor, width=i_lineWidth, style=line.style_solid)
    array.push(highLines, lineHigh)

    if i_showMidLine
        lineMid = line.new(x1=t1, y1=m1, x2=t2, y2=m2, xloc=xloc.bar_time, color=i_midColor, width=i_lineWidth, style=line.style_dashed)
        array.push(midLines, lineMid)

    lineLow = line.new(x1=t1, y1=l1, x2=t2, y2=l2, xloc=xloc.bar_time, color=i_lowColor, width=i_lineWidth, style=line.style_solid)
    array.push(lowLines, lineLow)

    if i_showBands
        fill = linefill.new(lineHigh, lineLow, color=color.new(#2196F3, 85))
        array.push(bandFills, fill)

drawPriceLabel(int barTime, float price, color col, string txt) =>
    lbl = label.new(x=barTime, y=price, text=txt + ": " + str.tostring(price, format.mintick), xloc=xloc.bar_time, color=color.new(col, 80), textcolor=col, style=label.style_label_left, size=getLabelSize())
    array.push(predLabels, lbl)

// ============================================================================
// MAIN LOGIC
// ============================================================================

if hasData
    currentBarTime = time

    if not na(prevHigh) and not na(prevBarTime)
        drawPredictionLines(prevBarTime, prevHigh, prevMid, prevLow, currentBarTime, predHigh, predMid, predLow)

    if i_showLabels and barstate.islast
        drawPriceLabel(currentBarTime, predHigh, i_highColor, "H")
        drawPriceLabel(currentBarTime, predMid, i_midColor, "M")
        drawPriceLabel(currentBarTime, predLow, i_lowColor, "L")

    prevHigh := predHigh
    prevMid := predMid
    prevLow := predLow
    prevBarTime := currentBarTime

// ============================================================================
// ARRAY CLEANUP
// ============================================================================

maxElements = 100

if array.size(highLines) > maxElements
    line.delete(array.shift(highLines))
if array.size(midLines) > maxElements
    line.delete(array.shift(midLines))
if array.size(lowLines) > maxElements
    line.delete(array.shift(lowLines))
if array.size(predLabels) > maxElements
    label.delete(array.shift(predLabels))
if array.size(bandFills) > maxElements
    linefill.delete(array.shift(bandFills))

// ============================================================================
// INFO TABLE
// ============================================================================

if i_showInfoTable
    var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 70), border_width=1, border_color=color.gray)

    if barstate.islast
        table.cell(infoTable, 0, 0, "Ciphex Predictions", text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 0, syminfo.ticker, text_color=color.white, text_size=size.small)

        if hasData
            table.cell(infoTable, 0, 1, "High", text_color=i_highColor, text_size=size.small)
            table.cell(infoTable, 1, 1, str.tostring(predHigh, format.mintick), text_color=i_highColor, text_size=size.small)

            table.cell(infoTable, 0, 2, "Mid", text_color=i_midColor, text_size=size.small)
            table.cell(infoTable, 1, 2, str.tostring(predMid, format.mintick), text_color=i_midColor, text_size=size.small)

            table.cell(infoTable, 0, 3, "Low", text_color=i_lowColor, text_size=size.small)
            table.cell(infoTable, 1, 3, str.tostring(predLow, format.mintick), text_color=i_lowColor, text_size=size.small)

            table.cell(infoTable, 0, 4, "Source", text_color=color.gray, text_size=size.tiny)
            table.cell(infoTable, 1, 4, DATA_PATH, text_color=color.gray, text_size=size.tiny)
        else
            table.cell(infoTable, 0, 1, "No data", text_color=color.gray, text_size=size.small)
            table.cell(infoTable, 1, 1, "Check symbol", text_color=color.gray, text_size=size.small)

// ============================================================================
// NO DATA WARNING
// ============================================================================

if barstate.islast and not hasData
    label.new(x=bar_index, y=close, text="No Ciphex predictions for " + syminfo.ticker + "\nPath: " + DATA_PATH, color=color.new(color.orange, 20), textcolor=color.white, style=label.style_label_left, size=size.normal)
